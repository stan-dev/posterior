<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pareto-khat diagnostics • posterior</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Pareto-khat diagnostics">
<meta property="og:description" content="posterior">
<meta property="og:image" content="https://mc-stan.org/posterior/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">posterior</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.6.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://mc-stan.org/rstan" class="external-link">rstan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/cmdstanr" class="external-link">cmdstanr</a>
    </li>
    <li>
      <a href="https://mc-stan.org/rstanarm" class="external-link">rstanarm</a>
    </li>
    <li>
      <a href="https://mc-stan.org/bayesplot" class="external-link">bayesplot</a>
    </li>
    <li>
      <a href="https://mc-stan.org/shinystan" class="external-link">shinystan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/loo" class="external-link">loo</a>
    </li>
    <li>
      <a href="https://mc-stan.org/projpred" class="external-link">projpred</a>
    </li>
    <li>
      <a href="https://mc-stan.org/rstantools" class="external-link">rstantools</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://mc-stan.org" class="external-link">Stan</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/mcmc_stan" class="external-link">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/stan-dev/posterior" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://discourse.mc-stan.org/" class="external-link">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Pareto-khat diagnostics</h1>
                        <h4 data-toc-skip class="author">Aki
Vehtari</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/stan-dev/posterior/blob/HEAD/vignettes/pareto_diagnostics.Rmd" class="external-link"><code>vignettes/pareto_diagnostics.Rmd</code></a></small>
      <div class="hidden name"><code>pareto_diagnostics.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The paper</p>
<ul>
<li>Aki Vehtari, Daniel Simpson, Andrew Gelman, Yuling Yao, and Jonah
Gabry (2024). Pareto smoothed importance sampling. <em>Journal of
Machine Learning Research</em>, 25(72):1-58.</li>
</ul>
<p>presents Pareto smoothed importance sampling, but also Pareto-<span class="math inline">\(\hat{k}\)</span> diagnostic that can be used when
estimating any expectation based on finite sample. This vignette
illustrates the use of these diagnostics. The individual diagnostic
functions are <code><a href="../reference/pareto_khat.html">pareto_khat()</a></code>, <code><a href="../reference/pareto_diags.html">pareto_min_ss()</a></code>,
<code><a href="../reference/pareto_diags.html">pareto_convergence_rate()</a></code> and
<code><a href="../reference/pareto_diags.html">pareto_khat_threshold()</a></code>. The function
<code><a href="../reference/pareto_diags.html">pareto_diags()</a></code> will return all of these.</p>
<p>Additionally, the <code><a href="../reference/pareto_smooth.html">pareto_smooth()</a></code> function can be used
to transform draws by smoothing the tail(s). ## Example</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/posterior/">posterior</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## This is posterior version 1.6.0</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'posterior'</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     mad, sd, var</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:base':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     %in%, match</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'dplyr'</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     filter, lag</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:base':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     intersect, setdiff, setequal, union</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>pillar.neg <span class="op">=</span> <span class="cn">FALSE</span>, pillar.subtle<span class="op">=</span><span class="cn">FALSE</span>, pillar.sigfig<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="simulated-data">Simulated data<a class="anchor" aria-label="anchor" href="#simulated-data"></a>
</h3>
<p>Generate <code>xn</code> a simulated MCMC sample with 4 chains each
with 1000 iterations using AR process with marginal normal(0,1)</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">phi</span> <span class="op">&lt;-</span> <span class="fl">0.3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">6534</span><span class="op">)</span></span>
<span><span class="va">dr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/arima.sim.html" class="external-link">arima.sim</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">N</span>,</span>
<span>                                                <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">phi</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                                sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">phi</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">4</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/draws_df.html">as_draws_df</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/variables-set.html">set_variables</a></span><span class="op">(</span><span class="st">'xn'</span><span class="op">)</span></span></code></pre></div>
<p>Transform <code>xn</code> via cdf-inverse-cdf so that we have
variables that have marginally distributions <span class="math inline">\(t_3\)</span>, <span class="math inline">\(t_{2.5}\)</span>, <span class="math inline">\(t_2\)</span>, <span class="math inline">\(t_{1.5}\)</span>, and <span class="math inline">\(t_1\)</span>. These all have thick tails. In
addition <span class="math inline">\(t_2\)</span>, <span class="math inline">\(t_{1.5}\)</span>, and <span class="math inline">\(t_1\)</span> have infinite variance, and <span class="math inline">\(t_1\)</span> (aka Cauchy) has infinite mean.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drt</span> <span class="op">&lt;-</span> <span class="va">dr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/mutate_variables.html">mutate_variables</a></span><span class="op">(</span>xt3<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">qt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">xn</span><span class="op">)</span>, df<span class="op">=</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>                   xt2_5<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">qt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">xn</span><span class="op">)</span>, df<span class="op">=</span><span class="fl">2.5</span><span class="op">)</span>,</span>
<span>                   xt2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">qt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">xn</span><span class="op">)</span>, df<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>                   xt1_5<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">qt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">xn</span><span class="op">)</span>, df<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span>,</span>
<span>                   xt1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">qt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">xn</span><span class="op">)</span>, df<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="mcmc-convergence-diagnostics">MCMC convergence diagnostics<a class="anchor" aria-label="anchor" href="#mcmc-convergence-diagnostics"></a>
</h3>
<p>We examine the draws with the default
<code><a href="../reference/draws_summary.html">summarise_draws()</a></code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/draws_summary.html">summarise_draws</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 6 × 10</span></span>
<span><span class="co">##   variable  mean  median    sd   mad    q5   q95  rhat ess_bulk ess_tail</span></span>
<span><span class="co">##   <span style="font-style: italic;">&lt;chr&gt;</span>    <span style="font-style: italic;">&lt;dbl&gt;</span>   <span style="font-style: italic;">&lt;dbl&gt;</span> <span style="font-style: italic;">&lt;dbl&gt;</span> <span style="font-style: italic;">&lt;dbl&gt;</span> <span style="font-style: italic;">&lt;dbl&gt;</span> <span style="font-style: italic;">&lt;dbl&gt;</span> <span style="font-style: italic;">&lt;dbl&gt;</span>    <span style="font-style: italic;">&lt;dbl&gt;</span>    <span style="font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## 1 xn       0.010 0.000<span style="text-decoration: underline;">94</span>  0.99  0.99  -1.6   1.6   1.0    <span style="text-decoration: underline;">2</span>284.    <span style="text-decoration: underline;">3</span>189.</span></span>
<span><span class="co">## 2 xt3      0.025 0.001<span style="text-decoration: underline;">0</span>   1.6   1.1   -2.3   2.3   1.0    <span style="text-decoration: underline;">2</span>284.    <span style="text-decoration: underline;">3</span>189.</span></span>
<span><span class="co">## 3 xt2_5    0.031 0.001<span style="text-decoration: underline;">0</span>   2.0   1.1   -2.5   2.5   1.0    <span style="text-decoration: underline;">2</span>284.    <span style="text-decoration: underline;">3</span>189.</span></span>
<span><span class="co">## 4 xt2      0.046 0.001<span style="text-decoration: underline;">1</span>   2.9   1.2   -2.8   2.9   1.0    <span style="text-decoration: underline;">2</span>284.    <span style="text-decoration: underline;">3</span>189.</span></span>
<span><span class="co">## 5 xt1_5    0.092 0.001<span style="text-decoration: underline;">1</span>   7.6   1.3   -3.5   3.6   1.0    <span style="text-decoration: underline;">2</span>284.    <span style="text-decoration: underline;">3</span>189.</span></span>
<span><span class="co">## 6 xt1      0.33  0.001<span style="text-decoration: underline;">2</span>  93.    1.5   -5.8   6.1   1.0    <span style="text-decoration: underline;">2</span>284.    <span style="text-decoration: underline;">3</span>189.</span></span></code></pre>
<p>All the usual convergence diagnostics <span class="math inline">\(\widehat{R}\)</span>, Bulk-ESS, and Tail-ESS look
good, which is fine as they have been designed to work also with
infinite variance (Vehtari et al., 2020).</p>
<p>If these variables would present variables of interest for which we
would like to estimate means, we would be also interested in Monte Carlo
standard error (MCSE, see case study <a href="https://users.aalto.fi/~ave/casestudies/Digits/digits.html" class="external-link">How
many iterations to run and how many digits to report</a>).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/draws_summary.html">summarise_draws</a></span><span class="op">(</span><span class="va">mean</span>, <span class="va">sd</span>, <span class="va">mcse_mean</span>, <span class="va">ess_bulk</span>, <span class="va">ess_basic</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 6 × 6</span></span>
<span><span class="co">##   variable  mean    sd mcse_mean ess_bulk ess_basic</span></span>
<span><span class="co">##   <span style="font-style: italic;">&lt;chr&gt;</span>    <span style="font-style: italic;">&lt;dbl&gt;</span> <span style="font-style: italic;">&lt;dbl&gt;</span>     <span style="font-style: italic;">&lt;dbl&gt;</span>    <span style="font-style: italic;">&lt;dbl&gt;</span>     <span style="font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## 1 xn       0.010  0.99     0.021    <span style="text-decoration: underline;">2</span>284.     <span style="text-decoration: underline;">2</span>280.</span></span>
<span><span class="co">## 2 xt3      0.025  1.6      0.033    <span style="text-decoration: underline;">2</span>284.     <span style="text-decoration: underline;">2</span>452.</span></span>
<span><span class="co">## 3 xt2_5    0.031  2.0      0.039    <span style="text-decoration: underline;">2</span>284.     <span style="text-decoration: underline;">2</span>584.</span></span>
<span><span class="co">## 4 xt2      0.046  2.9      0.054    <span style="text-decoration: underline;">2</span>284.     <span style="text-decoration: underline;">2</span>903.</span></span>
<span><span class="co">## 5 xt1_5    0.092  7.6      0.13     <span style="text-decoration: underline;">2</span>284.     <span style="text-decoration: underline;">3</span>553.</span></span>
<span><span class="co">## 6 xt1      0.33  93.       1.5      <span style="text-decoration: underline;">2</span>284.     <span style="text-decoration: underline;">3</span>976.</span></span></code></pre>
<p>Here MCSE for mean is based on standard deviation and Basic-ESS, but
these assume finite variance. We did sample also from distributions with
infinite variance, but given a finite sample size, the empirical
variance estimates are always finite, and thus we get overoptimistic
MCSE.</p>
</div>
</div>
<div class="section level2">
<h2 id="pareto-hatk">Pareto-<span class="math inline">\(\hat{k}\)</span><a class="anchor" aria-label="anchor" href="#pareto-hatk"></a>
</h2>
<p>To diagnose whether our variables of interest may have infinite
variance and even infinite mean, we can use Pareto-<span class="math inline">\(\hat{k}\)</span> diagnostic.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/draws_summary.html">summarise_draws</a></span><span class="op">(</span><span class="va">mean</span>, <span class="va">sd</span>, <span class="va">mcse_mean</span>, <span class="va">ess_basic</span>, <span class="va">pareto_khat</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 6 × 6</span></span>
<span><span class="co">##   variable  mean    sd mcse_mean ess_basic pareto_khat</span></span>
<span><span class="co">##   <span style="font-style: italic;">&lt;chr&gt;</span>    <span style="font-style: italic;">&lt;dbl&gt;</span> <span style="font-style: italic;">&lt;dbl&gt;</span>     <span style="font-style: italic;">&lt;dbl&gt;</span>     <span style="font-style: italic;">&lt;dbl&gt;</span>       <span style="font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## 1 xn       0.010  0.99     0.021     <span style="text-decoration: underline;">2</span>280.      -0.072</span></span>
<span><span class="co">## 2 xt3      0.025  1.6      0.033     <span style="text-decoration: underline;">2</span>452.       0.33 </span></span>
<span><span class="co">## 3 xt2_5    0.031  2.0      0.039     <span style="text-decoration: underline;">2</span>584.       0.41 </span></span>
<span><span class="co">## 4 xt2      0.046  2.9      0.054     <span style="text-decoration: underline;">2</span>903.       0.52 </span></span>
<span><span class="co">## 5 xt1_5    0.092  7.6      0.13      <span style="text-decoration: underline;">3</span>553.       0.69 </span></span>
<span><span class="co">## 6 xt1      0.33  93.       1.5       <span style="text-decoration: underline;">3</span>976.       1.0</span></span></code></pre>
<p><span class="math inline">\(\hat{k} \leq 0\)</span> indicates that
all moments exist, and the inverse of positive <span class="math inline">\(\hat{k}\)</span> tells estimate for the number of
finite (fractional) moments. Thus, <span class="math inline">\(\hat{k}\geq 1/2\)</span> indicates infinite
variance, and <span class="math inline">\(\hat{k}\geq 1\)</span>
indicates infinite mean. Sometimes very thick distribution tails may
affect also sampling, but assuming sampling did go well, and we would be
interested only in quantiles, infinite variance and mean are not a
problem. But if we are interested in mean, then we need to care about
the number of (fractional) moments. Here we see <span class="math inline">\(\hat{k} \geq 1/2\)</span> for <span class="math inline">\(t_2\)</span>, <span class="math inline">\(t_{1.5}\)</span>, and <span class="math inline">\(t_{1}\)</span>, and we should not trust their
<code>mcse_mean</code> values. Without trustworthy MCSE estimate we
don’t have good estimate of how accurate the mean estimate is.
Furthermore, as <span class="math inline">\(\hat{k} \geq 1\)</span> for
<span class="math inline">\(t_{1}\)</span>, the mean is not finite and
the mean estimate is not valid.</p>
</div>
<div class="section level2">
<h2 id="pareto-smoothing">Pareto smoothing<a class="anchor" aria-label="anchor" href="#pareto-smoothing"></a>
</h2>
<p>If we really do need those mean estimates, we can improve
trustworthiness by Pareto smoothing, which replaces extreme tail draws
with expected ordered statistics of Pareto distribution fitted to the
tails of the distribution. Pareto smoothed mean estimate (computed using
Pareto smoothed draws) has finite variance with a cost of some bias
which we know when it is negligible. As a thumb rule when <span class="math inline">\(\hat{k}&lt;0.7\)</span>, the bias is
negligible.</p>
<p>We do Pareto smoothing for all the variables.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drts</span> <span class="op">&lt;-</span> <span class="va">drt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/mutate_variables.html">mutate_variables</a></span><span class="op">(</span>xt3_s<span class="op">=</span><span class="fu"><a href="../reference/pareto_smooth.html">pareto_smooth</a></span><span class="op">(</span><span class="va">xt3</span><span class="op">)</span>,</span>
<span>                   xt2_5_s<span class="op">=</span><span class="fu"><a href="../reference/pareto_smooth.html">pareto_smooth</a></span><span class="op">(</span><span class="va">xt2_5</span><span class="op">)</span>,</span>
<span>                   xt2_s<span class="op">=</span><span class="fu"><a href="../reference/pareto_smooth.html">pareto_smooth</a></span><span class="op">(</span><span class="va">xt2</span><span class="op">)</span>,</span>
<span>                   xt1_5_s<span class="op">=</span><span class="fu"><a href="../reference/pareto_smooth.html">pareto_smooth</a></span><span class="op">(</span><span class="va">xt1_5</span><span class="op">)</span>,</span>
<span>                   xt1_s<span class="op">=</span><span class="fu"><a href="../reference/pareto_smooth.html">pareto_smooth</a></span><span class="op">(</span><span class="va">xt1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/subset_draws.html">subset_draws</a></span><span class="op">(</span>variable<span class="op">=</span><span class="st">"_s"</span>, regex<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Pareto k-hat = 0.32.</span></span></code></pre>
<pre><code><span><span class="co">## Pareto k-hat = 0.4.</span></span></code></pre>
<pre><code><span><span class="co">## Pareto k-hat = 0.51.</span></span></code></pre>
<pre><code><span><span class="co">## Pareto k-hat = 0.68.</span></span></code></pre>
<pre><code><span><span class="co">## Pareto k-hat = 1.02. Mean does not exist, making empirical mean estimate of the draws not applicable.</span></span></code></pre>
<p>Now the <code>mcse_mean</code> values are more trustworthy when <span class="math inline">\(\hat{k} &lt; 0.7\)</span>. When <span class="math inline">\(\hat{k}&gt;0.7\)</span> both bias and variance
grow so fast that Pareto smoothing rarely helps (see more details in the
paper).</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/draws_summary.html">summarise_draws</a></span><span class="op">(</span><span class="va">mean</span>, <span class="va">mcse_mean</span>, <span class="va">ess_basic</span>, <span class="va">pareto_khat</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 5 × 5</span></span>
<span><span class="co">##   variable  mean mcse_mean ess_basic pareto_khat</span></span>
<span><span class="co">##   <span style="font-style: italic;">&lt;chr&gt;</span>    <span style="font-style: italic;">&lt;dbl&gt;</span>     <span style="font-style: italic;">&lt;dbl&gt;</span>     <span style="font-style: italic;">&lt;dbl&gt;</span>       <span style="font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## 1 xt3_s    0.026     0.033     <span style="text-decoration: underline;">2</span>438.        0.33</span></span>
<span><span class="co">## 2 xt2_5_s  0.033     0.038     <span style="text-decoration: underline;">2</span>536.        0.40</span></span>
<span><span class="co">## 3 xt2_s    0.052     0.051     <span style="text-decoration: underline;">2</span>763.        0.50</span></span>
<span><span class="co">## 4 xt1_5_s  0.12      0.10      <span style="text-decoration: underline;">3</span>293.        0.67</span></span>
<span><span class="co">## 5 xt1_s    0.97      0.80      <span style="text-decoration: underline;">3</span>903.        0.98</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="minimum-sample-size-required">Minimum sample size required<a class="anchor" aria-label="anchor" href="#minimum-sample-size-required"></a>
</h2>
<p>The bias and variance depend on the sample size, and we can use
additional diagnostic <code>min_ss</code> which tells the minimum sample
size needed so that <code>mcse_mean</code> can be trusted.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/draws_summary.html">summarise_draws</a></span><span class="op">(</span><span class="va">mean</span>, <span class="va">mcse_mean</span>, <span class="va">ess_basic</span>,</span>
<span>                  <span class="va">pareto_khat</span>, min_ss<span class="op">=</span><span class="va">pareto_min_ss</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 6 × 6</span></span>
<span><span class="co">##   variable  mean mcse_mean ess_basic pareto_khat min_ss</span></span>
<span><span class="co">##   <span style="font-style: italic;">&lt;chr&gt;</span>    <span style="font-style: italic;">&lt;dbl&gt;</span>     <span style="font-style: italic;">&lt;dbl&gt;</span>     <span style="font-style: italic;">&lt;dbl&gt;</span>       <span style="font-style: italic;">&lt;dbl&gt;</span>  <span style="font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## 1 xn       0.010     0.021     <span style="text-decoration: underline;">2</span>280.      -0.072    10 </span></span>
<span><span class="co">## 2 xt3      0.025     0.033     <span style="text-decoration: underline;">2</span>452.       0.33     31.</span></span>
<span><span class="co">## 3 xt2_5    0.031     0.039     <span style="text-decoration: underline;">2</span>584.       0.41     48.</span></span>
<span><span class="co">## 4 xt2      0.046     0.054     <span style="text-decoration: underline;">2</span>903.       0.52    116.</span></span>
<span><span class="co">## 5 xt1_5    0.092     0.13      <span style="text-decoration: underline;">3</span>553.       0.69   <span style="text-decoration: underline;">1</span>735.</span></span>
<span><span class="co">## 6 xt1      0.33      1.5       <span style="text-decoration: underline;">3</span>976.       1.0     <span style="color: #BB0000;">Inf</span></span></span></code></pre>
<p>Here required <code>min_ss</code> is smaller than
<code>ess_basic</code> for all except <span class="math inline">\(t_1\)</span>, for which there is no hope.</p>
</div>
<div class="section level2">
<h2 id="convergence-rate">Convergence rate<a class="anchor" aria-label="anchor" href="#convergence-rate"></a>
</h2>
<p>Given finite variance, the central limit theorem states that to halve
MCSE we need four times bigger sample size. With Pareto smoothing, we
can go further, but the convergence rate decreases when <span class="math inline">\(\hat{k}\)</span> increases.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/draws_summary.html">summarise_draws</a></span><span class="op">(</span><span class="va">mean</span>, <span class="va">mcse_mean</span>, <span class="va">ess_basic</span>,</span>
<span>                  <span class="va">pareto_khat</span>, min_ss<span class="op">=</span><span class="va">pareto_min_ss</span>,</span>
<span>                  conv_rate<span class="op">=</span><span class="va">pareto_convergence_rate</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 6 × 7</span></span>
<span><span class="co">##   variable  mean mcse_mean ess_basic pareto_khat min_ss conv_rate</span></span>
<span><span class="co">##   <span style="font-style: italic;">&lt;chr&gt;</span>    <span style="font-style: italic;">&lt;dbl&gt;</span>     <span style="font-style: italic;">&lt;dbl&gt;</span>     <span style="font-style: italic;">&lt;dbl&gt;</span>       <span style="font-style: italic;">&lt;dbl&gt;</span>  <span style="font-style: italic;">&lt;dbl&gt;</span>     <span style="font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## 1 xn       0.010     0.021     <span style="text-decoration: underline;">2</span>280.      -0.072    10       1   </span></span>
<span><span class="co">## 2 xt3      0.025     0.033     <span style="text-decoration: underline;">2</span>452.       0.33     31.      0.98</span></span>
<span><span class="co">## 3 xt2_5    0.031     0.039     <span style="text-decoration: underline;">2</span>584.       0.41     48.      0.95</span></span>
<span><span class="co">## 4 xt2      0.046     0.054     <span style="text-decoration: underline;">2</span>903.       0.52    116.      0.86</span></span>
<span><span class="co">## 5 xt1_5    0.092     0.13      <span style="text-decoration: underline;">3</span>553.       0.69   <span style="text-decoration: underline;">1</span>735.      0.60</span></span>
<span><span class="co">## 6 xt1      0.33      1.5       <span style="text-decoration: underline;">3</span>976.       1.0     <span style="color: #BB0000;">Inf</span>       0</span></span></code></pre>
<p>We see that with <span class="math inline">\(t_2\)</span>, <span class="math inline">\(t_{1.5}\)</span>, and <span class="math inline">\(t_1\)</span> we need <span class="math inline">\(4^{1/0.86}\approx 5\)</span>, <span class="math inline">\(4^{1/0.60}\approx 10\)</span>, and <span class="math inline">\(4^{1/0}\approx \infty\)</span> times bigger sample
sizes to halve MCSE for mean.</p>
</div>
<div class="section level2">
<h2 id="pareto-hatk-threshold">Pareto-<span class="math inline">\(\hat{k}\)</span>-threshold<a class="anchor" aria-label="anchor" href="#pareto-hatk-threshold"></a>
</h2>
<p>The final Pareto diagnostic, <span class="math inline">\(\hat{k}\)</span>-threshold, is useful for smaller
sample sizes. Here we select only 100 iterations per chain to get total
of 400 draws.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/subset_draws.html">subset_draws</a></span><span class="op">(</span>iteration<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/draws_summary.html">summarise_draws</a></span><span class="op">(</span><span class="va">mean</span>, <span class="va">mcse_mean</span>, <span class="va">ess_basic</span>,</span>
<span>                  <span class="va">pareto_khat</span>, min_ss<span class="op">=</span><span class="va">pareto_min_ss</span>,</span>
<span>                  khat_thres<span class="op">=</span><span class="va">pareto_khat_threshold</span>,</span>
<span>                  conv_rate<span class="op">=</span><span class="va">pareto_convergence_rate</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 6 × 8</span></span>
<span><span class="co">##   variable   mean mcse_mean ess_basic pareto_khat min_ss khat_thres conv_rate</span></span>
<span><span class="co">##   <span style="font-style: italic;">&lt;chr&gt;</span>     <span style="font-style: italic;">&lt;dbl&gt;</span>     <span style="font-style: italic;">&lt;dbl&gt;</span>     <span style="font-style: italic;">&lt;dbl&gt;</span>       <span style="font-style: italic;">&lt;dbl&gt;</span>  <span style="font-style: italic;">&lt;dbl&gt;</span>      <span style="font-style: italic;">&lt;dbl&gt;</span>     <span style="font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## 1 xn        0.038     0.066      244.      -0.012 1  e 1       0.62      1   </span></span>
<span><span class="co">## 2 xt3       0.054     0.11       237.       0.32  3.0e 1       0.62      0.96</span></span>
<span><span class="co">## 3 xt2_5     0.057     0.13       237.       0.38  4.2e 1       0.62      0.93</span></span>
<span><span class="co">## 4 xt2       0.063     0.17       243.       0.48  8.3e 1       0.62      0.86</span></span>
<span><span class="co">## 5 xt1_5     0.061     0.31       271.       0.64  5.6e 2       0.62      0.66</span></span>
<span><span class="co">## 6 xt1      -0.26      1.6        344.       0.95  2.2e18       0.62      0.11</span></span></code></pre>
<p>With only 400 draws, we can trust the Pareto smoothed result only
when <span class="math inline">\(\hat{k}&lt;0.62\)</span>. For <span class="math inline">\(t_{1.5}\)</span> <span class="math inline">\(\hat{k}\approx 0.64\)</span>, and
<code>min_ss</code> reveals we would probably need more than 560 draws
to be on the safe side.</p>
</div>
<div class="section level2">
<h2 id="pareto-diagnostics">Pareto diagnostics<a class="anchor" aria-label="anchor" href="#pareto-diagnostics"></a>
</h2>
<p>We can get all these diagnostics with <code><a href="../reference/pareto_diags.html">pareto_diags()</a></code>,
and it’s easy to use it also for derived quantities.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/mutate_variables.html">mutate_variables</a></span><span class="op">(</span>xt2_5_sq<span class="op">=</span><span class="va">xt2_5</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/subset_draws.html">subset_draws</a></span><span class="op">(</span>variable<span class="op">=</span><span class="st">"xt2_5_sq"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/draws_summary.html">summarise_draws</a></span><span class="op">(</span><span class="va">mean</span>, <span class="va">mcse_mean</span>,</span>
<span>                  <span class="va">pareto_diags</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 1 × 7</span></span>
<span><span class="co">##   variable  mean mcse_mean  khat min_ss khat_threshold convergence_rate</span></span>
<span><span class="co">##   <span style="font-style: italic;">&lt;chr&gt;</span>    <span style="font-style: italic;">&lt;dbl&gt;</span>     <span style="font-style: italic;">&lt;dbl&gt;</span> <span style="font-style: italic;">&lt;dbl&gt;</span>  <span style="font-style: italic;">&lt;dbl&gt;</span>          <span style="font-style: italic;">&lt;dbl&gt;</span>            <span style="font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## 1 xt2_5_sq   3.9      0.56  0.67  <span style="text-decoration: underline;">1</span>124.           0.72             0.63</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="discussion">Discussion<a class="anchor" aria-label="anchor" href="#discussion"></a>
</h2>
<p>All these diagnostics are presented in Section 3 and summarized in
Table 1 in PSIS paper (Vehtari et al., 2024).</p>
<p>If you don’t need to estimate means of thick tailed distributions,
and there are no sampling issues due to thick tails, then you don’t need
to check existence of finite variance, and thus there is no need to
check Pareto-<span class="math inline">\(\hat{k}\)</span> for all the
parameters and derived quantities.</p>
<p>It is possible that the distribution has finite variance, but
pre-asymptotically given a finite sample size the behavior can be
similar to infinite variance. Thus the diagnostic is useful even in
cases where theory guarantees finite variance.</p>
</div>
<div class="section level2">
<h2 id="reference">Reference<a class="anchor" aria-label="anchor" href="#reference"></a>
</h2>
<p>Vehtari, A., Simpson, D., Gelman, A., Yao, Y., &amp; Gabry, J.
(2024). Pareto smoothed importance sampling. <em>Journal of Machine
Learning Research</em>, 25(72):1-58.</p>
<p>Vehtari A., Gelman A., Simpson D., Carpenter B., &amp; Bürkner P. C.
(2020). Rank-normalization, folding, and localization: An improved Rhat
for assessing convergence of MCMC. <em>Bayesian Analysis</em>,
16(2):667-718.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Paul-Christian Bürkner, Jonah Gabry, Matthew Kay, Aki Vehtari.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
